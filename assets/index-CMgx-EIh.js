(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&n(a)}).observe(document,{childList:!0,subtree:!0});function r(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function n(s){if(s.ep)return;s.ep=!0;const i=r(s);fetch(s.href,i)}})();const _t=!1;var kt=Array.isArray,fr=Array.prototype.indexOf,Ye=Array.from,cr=Object.defineProperty,gt=Object.getOwnPropertyDescriptor,dr=Object.getOwnPropertyDescriptors,pr=Object.getPrototypeOf;function hr(t){return t()}function vt(t){for(var e=0;e<t.length;e++)t[e]()}const R=2,Ut=4,Ue=8,Ke=16,H=32,ge=64,Ee=128,N=256,Ae=512,T=1024,z=2048,oe=4096,W=8192,Me=16384,_r=32768,Ve=65536,gr=1<<19,Mt=1<<20,mt=Symbol("$state");function Rt(t){return t===this.v}function vr(t,e){return t!=t?e==e:t!==e||t!==null&&typeof t=="object"||typeof t=="function"}function Gt(t){return!vr(t,this.v)}function mr(t){throw new Error("https://svelte.dev/e/effect_in_teardown")}function yr(){throw new Error("https://svelte.dev/e/effect_in_unowned_derived")}function xr(t){throw new Error("https://svelte.dev/e/effect_orphan")}function wr(){throw new Error("https://svelte.dev/e/effect_update_depth_exceeded")}function br(){throw new Error("https://svelte.dev/e/state_unsafe_local_read")}function Or(){throw new Error("https://svelte.dev/e/state_unsafe_mutation")}let ve=!1,Er=!1;function Ar(){ve=!0}const $r=1,Ir=2,Br=16,Pr=1,Sr=2,Dr=Symbol();function Tr(t){throw new Error("https://svelte.dev/e/lifecycle_outside_component")}let b=null;function yt(t){b=t}function Ft(t,e=!1,r){b={p:b,c:null,e:null,m:!1,s:t,x:null,l:null},ve&&!e&&(b.l={s:null,u:null,r1:[],r2:$e(!1)})}function Ct(t){const e=b;if(e!==null){const a=e.e;if(a!==null){var r=w,n=x;e.e=null;try{for(var s=0;s<a.length;s++){var i=a[s];ae(i.effect),ie(i.reaction),Jt(i.fn)}}finally{ae(r),ie(n)}}b=e.p,e.m=!0}return{}}function Re(){return!ve||b!==null&&b.l===null}function $e(t,e){var r={f:0,v:t,reactions:null,equals:Rt,rv:0,wv:0};return r}function Nt(t,e=!1){var n;const r=$e(t);return e||(r.equals=Gt),ve&&b!==null&&b.l!==null&&((n=b.l).s??(n.s=[])).push(r),r}function Ne(t,e=!1){return kr(Nt(t,e))}function kr(t){return x!==null&&!q&&x.f&R&&(C===null?Hr([t]):C.push(t)),t}function we(t,e){return x!==null&&!q&&Re()&&x.f&(R|Ke)&&(C===null||!C.includes(t))&&Or(),Lt(t,e)}function Lt(t,e){return t.equals(e)||(t.v,t.v=e,t.wv=nr(),Wt(t,z),Re()&&w!==null&&w.f&T&&!(w.f&(H|ge))&&(L===null?zr([t]):L.push(t))),e}function Wt(t,e){var r=t.reactions;if(r!==null)for(var n=Re(),s=r.length,i=0;i<s;i++){var a=r[i],o=a.f;o&z||!n&&a===w||(j(a,e),o&(T|N)&&(o&R?Wt(a,oe):Ce(a)))}}let Ur=!1;var xt,qt,jt;function Mr(){if(xt===void 0){xt=window;var t=Element.prototype,e=Node.prototype;qt=gt(e,"firstChild").get,jt=gt(e,"nextSibling").get,t.__click=void 0,t.__className="",t.__attributes=null,t.__styles=null,t.__e=void 0,Text.prototype.__t=void 0}}function Ht(t=""){return document.createTextNode(t)}function Ie(t){return qt.call(t)}function Ge(t){return jt.call(t)}function We(t,e){return Ie(t)}function Rr(t,e){{var r=Ie(t);return r instanceof Comment&&r.data===""?Ge(r):r}}function wt(t,e=1,r=!1){let n=t;for(;e--;)n=Ge(n);return n}function Gr(t){t.textContent=""}function Je(t){var e=R|z,r=x!==null&&x.f&R?x:null;return w===null||r!==null&&r.f&N?e|=N:w.f|=Mt,{ctx:b,deps:null,effects:null,equals:Rt,f:e,fn:t,reactions:null,rv:0,v:null,wv:0,parent:r??w}}function zt(t){const e=Je(t);return e.equals=Gt,e}function Yt(t){var e=t.effects;if(e!==null){t.effects=null;for(var r=0;r<e.length;r+=1)X(e[r])}}function Fr(t){for(var e=t.parent;e!==null;){if(!(e.f&R))return e;e=e.parent}return null}function Cr(t){var e,r=w;ae(Fr(t));try{Yt(t),e=ir(t)}finally{ae(r)}return e}function Kt(t){var e=Cr(t),r=(ee||t.f&N)&&t.deps!==null?oe:T;j(t,r),t.equals(e)||(t.v=e,t.wv=nr())}function Vt(t){w===null&&x===null&&xr(),x!==null&&x.f&N&&w===null&&yr(),Ze&&mr()}function Nr(t,e){var r=e.last;r===null?e.last=e.first=t:(r.next=t,t.prev=r,e.last=t)}function me(t,e,r,n=!0){var s=(t&ge)!==0,i=w,a={ctx:b,deps:null,nodes_start:null,nodes_end:null,f:t|z,first:null,fn:e,last:null,next:null,parent:s?null:i,prev:null,teardown:null,transitions:null,wv:0};if(r){var o=se;try{Ot(!0),et(a),a.f|=_r}catch(c){throw X(a),c}finally{Ot(o)}}else e!==null&&Ce(a);var u=r&&a.deps===null&&a.first===null&&a.nodes_start===null&&a.teardown===null&&(a.f&(Mt|Ee))===0;if(!u&&!s&&n&&(i!==null&&Nr(a,i),x!==null&&x.f&R)){var f=x;(f.effects??(f.effects=[])).push(a)}return a}function qe(t){Vt();var e=w!==null&&(w.f&H)!==0&&b!==null&&!b.m;if(e){var r=b;(r.e??(r.e=[])).push({fn:t,effect:w,reaction:x})}else{var n=Jt(t);return n}}function Lr(t){return Vt(),qr(t)}function Wr(t){const e=me(ge,t,!0);return(r={})=>new Promise(n=>{r.outro?Be(e,()=>{X(e),n(void 0)}):(X(e),n(void 0))})}function Jt(t){return me(Ut,t,!1)}function qr(t){return me(Ue,t,!0)}function bt(t,e=[],r=Je){const n=e.map(r);return Xe(()=>t(...n.map(M)))}function Xe(t,e=0){return me(Ue|Ke|e,t,!0)}function _e(t,e=!0){return me(Ue|H,t,!0,e)}function Xt(t){var e=t.teardown;if(e!==null){const r=Ze,n=x;Et(!0),ie(null);try{e.call(null)}finally{Et(r),ie(n)}}}function Qt(t,e=!1){var r=t.first;for(t.first=t.last=null;r!==null;){var n=r.next;X(r,e),r=n}}function jr(t){for(var e=t.first;e!==null;){var r=e.next;e.f&H||X(e),e=r}}function X(t,e=!0){var r=!1;if((e||t.f&gr)&&t.nodes_start!==null){for(var n=t.nodes_start,s=t.nodes_end;n!==null;){var i=n===s?null:Ge(n);n.remove(),n=i}r=!0}Qt(t,e&&!r),ke(t,0),j(t,Me);var a=t.transitions;if(a!==null)for(const u of a)u.stop();Xt(t);var o=t.parent;o!==null&&o.first!==null&&Zt(t),t.next=t.prev=t.teardown=t.ctx=t.deps=t.fn=t.nodes_start=t.nodes_end=null}function Zt(t){var e=t.parent,r=t.prev,n=t.next;r!==null&&(r.next=n),n!==null&&(n.prev=r),e!==null&&(e.first===t&&(e.first=n),e.last===t&&(e.last=r))}function Be(t,e){var r=[];Qe(t,r,!0),er(r,()=>{X(t),e&&e()})}function er(t,e){var r=t.length;if(r>0){var n=()=>--r||e();for(var s of t)s.out(n)}else e()}function Qe(t,e,r){if(!(t.f&W)){if(t.f^=W,t.transitions!==null)for(const a of t.transitions)(a.is_global||r)&&e.push(a);for(var n=t.first;n!==null;){var s=n.next,i=(n.f&Ve)!==0||(n.f&H)!==0;Qe(n,e,i?r:!1),n=s}}}function Pe(t){tr(t,!0)}function tr(t,e){if(t.f&W){t.f^=W,t.f&T||(t.f^=T),ye(t)&&(j(t,z),Ce(t));for(var r=t.first;r!==null;){var n=r.next,s=(r.f&Ve)!==0||(r.f&H)!==0;tr(r,s?e:!1),r=n}if(t.transitions!==null)for(const i of t.transitions)(i.is_global||e)&&i.in()}}let Oe=!1,Se=!1,De=null,se=!1,Ze=!1;function Ot(t){se=t}function Et(t){Ze=t}let je=[],he=0;let x=null,q=!1;function ie(t){x=t}let w=null;function ae(t){w=t}let C=null;function Hr(t){C=t}let D=null,U=0,L=null;function zr(t){L=t}let rr=1,Te=0,ee=!1;function nr(){return++rr}function ye(t){var f;var e=t.f;if(e&z)return!0;if(e&oe){var r=t.deps,n=(e&N)!==0;if(r!==null){var s,i,a=(e&Ae)!==0,o=n&&w!==null&&!ee,u=r.length;if(a||o){for(s=0;s<u;s++)i=r[s],(a||!((f=i==null?void 0:i.reactions)!=null&&f.includes(t)))&&(i.reactions??(i.reactions=[])).push(t);a&&(t.f^=Ae)}for(s=0;s<u;s++)if(i=r[s],ye(i)&&Kt(i),i.wv>t.wv)return!0}(!n||w!==null&&!ee)&&j(t,T)}return!1}function Yr(t,e){for(var r=e;r!==null;){if(r.f&Ee)try{r.fn(t);return}catch{r.f^=Ee}r=r.parent}throw Oe=!1,t}function Kr(t){return(t.f&Me)===0&&(t.parent===null||(t.parent.f&Ee)===0)}function Fe(t,e,r,n){if(Oe){if(r===null&&(Oe=!1),Kr(e))throw t;return}r!==null&&(Oe=!0);{Yr(t,e);return}}function sr(t,e,r=0){var n=t.reactions;if(n!==null)for(var s=0;s<n.length;s++){var i=n[s];i.f&R?sr(i,e,r+1):e===i&&(r===0?j(i,z):i.f&T&&j(i,oe),Ce(i))}}function ir(t){var p;var e=D,r=U,n=L,s=x,i=ee,a=C,o=b,u=q,f=t.f;D=null,U=0,L=null,x=f&(H|ge)?null:t,ee=(f&N)!==0&&(!se||(s===null||u)&&t.parent!==null),C=null,yt(t.ctx),q=!1,Te++;try{var c=(0,t.fn)(),d=t.deps;if(D!==null){var l;if(ke(t,U),d!==null&&U>0)for(d.length=U+D.length,l=0;l<D.length;l++)d[U+l]=D[l];else t.deps=d=D;if(!ee)for(l=U;l<d.length;l++)((p=d[l]).reactions??(p.reactions=[])).push(t)}else d!==null&&U<d.length&&(ke(t,U),d.length=U);if(Re()&&L!==null&&!(t.f&(R|oe|z)))for(l=0;l<L.length;l++)sr(L[l],t);return s!==null&&Te++,c}finally{D=e,U=r,L=n,x=s,ee=i,C=a,yt(o),q=u}}function Vr(t,e){let r=e.reactions;if(r!==null){var n=fr.call(r,t);if(n!==-1){var s=r.length-1;s===0?r=e.reactions=null:(r[n]=r[s],r.pop())}}r===null&&e.f&R&&(D===null||!D.includes(e))&&(j(e,oe),e.f&(N|Ae)||(e.f^=Ae),Yt(e),ke(e,0))}function ke(t,e){var r=t.deps;if(r!==null)for(var n=e;n<r.length;n++)Vr(t,r[n])}function et(t){var e=t.f;if(!(e&Me)){j(t,T);var r=w,n=b;w=t;try{e&Ke?jr(t):Qt(t),Xt(t);var s=ir(t);t.teardown=typeof s=="function"?s:null,t.wv=rr;var i=t.deps,a;_t&&Er&&t.f&z}catch(o){Fe(o,t,r,n||t.ctx)}finally{w=r}}}function Jr(){if(he>1e3){he=0;try{wr()}catch(t){if(De!==null)Fe(t,De,null);else throw t}}he++}function Xr(t){var e=t.length;if(e!==0){Jr();var r=se;se=!0;try{for(var n=0;n<e;n++){var s=t[n];s.f&T||(s.f^=T);var i=[];ar(s,i),Qr(i)}}finally{se=r}}}function Qr(t){var e=t.length;if(e!==0)for(var r=0;r<e;r++){var n=t[r];if(!(n.f&(Me|W)))try{ye(n)&&(et(n),n.deps===null&&n.first===null&&n.nodes_start===null&&(n.teardown===null?Zt(n):n.fn=null))}catch(s){Fe(s,n,null,n.ctx)}}}function Zr(){if(Se=!1,he>1001)return;const t=je;je=[],Xr(t),Se||(he=0,De=null)}function Ce(t){Se||(Se=!0,queueMicrotask(Zr)),De=t;for(var e=t;e.parent!==null;){e=e.parent;var r=e.f;if(r&(ge|H)){if(!(r&T))return;e.f^=T}}je.push(e)}function ar(t,e){var r=t.first,n=[];e:for(;r!==null;){var s=r.f,i=(s&H)!==0,a=i&&(s&T)!==0,o=r.next;if(!a&&!(s&W))if(s&Ue){if(i)r.f^=T;else{var u=x;try{x=r,ye(r)&&et(r)}catch(l){Fe(l,r,null,r.ctx)}finally{x=u}}var f=r.first;if(f!==null){r=f;continue}}else s&Ut&&n.push(r);if(o===null){let l=r.parent;for(;l!==null;){if(t===l)break e;var c=l.next;if(c!==null){r=c;continue e}l=l.parent}}r=o}for(var d=0;d<n.length;d++)f=n[d],e.push(f),ar(f,e)}function M(t){var e=t.f,r=(e&R)!==0;if(x!==null&&!q){C!==null&&C.includes(t)&&br();var n=x.deps;t.rv<Te&&(t.rv=Te,D===null&&n!==null&&n[U]===t?U++:D===null?D=[t]:D.push(t))}else if(r&&t.deps===null&&t.effects===null){var s=t,i=s.parent;i!==null&&!(i.f&N)&&(s.f^=N)}return r&&(s=t,ye(s)&&Kt(s)),t.v}function or(t){var e=q;try{return q=!0,t()}finally{q=e}}const en=-7169;function j(t,e){t.f=t.f&en|e}function tn(t){if(!(typeof t!="object"||!t||t instanceof EventTarget)){if(mt in t)He(t);else if(!Array.isArray(t))for(let e in t){const r=t[e];typeof r=="object"&&r&&mt in r&&He(r)}}}function He(t,e=new Set){if(typeof t=="object"&&t!==null&&!(t instanceof EventTarget)&&!e.has(t)){e.add(t),t instanceof Date&&t.getTime();for(let n in t)try{He(t[n],e)}catch{}const r=pr(t);if(r!==Object.prototype&&r!==Array.prototype&&r!==Map.prototype&&r!==Set.prototype&&r!==Date.prototype){const n=dr(r);for(let s in n){const i=n[s].get;if(i)try{i.call(t)}catch{}}}}}const rn=["touchstart","touchmove"];function nn(t){return rn.includes(t)}const sn=new Set,At=new Set;function be(t){var k;var e=this,r=e.ownerDocument,n=t.type,s=((k=t.composedPath)==null?void 0:k.call(t))||[],i=s[0]||t.target,a=0,o=t.__root;if(o){var u=s.indexOf(o);if(u!==-1&&(e===document||e===window)){t.__root=e;return}var f=s.indexOf(e);if(f===-1)return;u<=f&&(a=u)}if(i=s[a]||t.target,i!==e){cr(t,"currentTarget",{configurable:!0,get(){return i||r}});var c=x,d=w;ie(null),ae(null);try{for(var l,p=[];i!==null;){var m=i.assignedSlot||i.parentNode||i.host||null;try{var B=i["__"+n];if(B!==void 0&&!i.disabled)if(kt(B)){var[G,...O]=B;G.apply(i,[t,...O])}else B.call(i,t)}catch(_){l?p.push(_):l=_}if(t.cancelBubble||m===e||m===null)break;i=m}if(l){for(let _ of p)queueMicrotask(()=>{throw _});throw l}}finally{t.__root=e,delete t.currentTarget,ie(c),ae(d)}}}function an(t){var e=document.createElement("template");return e.innerHTML=t,e.content}function $t(t,e){var r=w;r.nodes_start===null&&(r.nodes_start=t,r.nodes_end=e)}function xe(t,e){var r=(e&Pr)!==0,n=(e&Sr)!==0,s,i=!t.startsWith("<!>");return()=>{s===void 0&&(s=an(i?t:"<!>"+t),r||(s=Ie(s)));var a=n?document.importNode(s,!0):s.cloneNode(!0);if(r){var o=Ie(a),u=a.lastChild;$t(o,u)}else $t(a,a);return a}}function de(t,e){t!==null&&t.before(e)}function It(t,e){var r=e==null?"":typeof e=="object"?e+"":e;r!==(t.__t??(t.__t=t.nodeValue))&&(t.__t=r,t.nodeValue=r+"")}function on(t,e){return un(t,e)}const re=new Map;function un(t,{target:e,anchor:r,props:n={},events:s,context:i,intro:a=!0}){Mr();var o=new Set,u=d=>{for(var l=0;l<d.length;l++){var p=d[l];if(!o.has(p)){o.add(p);var m=nn(p);e.addEventListener(p,be,{passive:m});var B=re.get(p);B===void 0?(document.addEventListener(p,be,{passive:m}),re.set(p,1)):re.set(p,B+1)}}};u(Ye(sn)),At.add(u);var f=void 0,c=Wr(()=>{var d=r??e.appendChild(Ht());return _e(()=>{if(i){Ft({});var l=b;l.c=i}s&&(n.$$events=s),f=t(d,n)||{},i&&Ct()}),()=>{var m;for(var l of o){e.removeEventListener(l,be);var p=re.get(l);--p===0?(document.removeEventListener(l,be),re.delete(l)):re.set(l,p)}At.delete(u),d!==r&&((m=d.parentNode)==null||m.removeChild(d))}});return ln.set(f,c),f}let ln=new WeakMap;function ze(t,e,r=!1){var n=t,s=null,i=null,a=Dr,o=r?Ve:0,u=!1;const f=(d,l=!0)=>{u=!0,c(l,d)},c=(d,l)=>{a!==(a=d)&&(a?(s?Pe(s):l&&(s=_e(()=>l(n))),i&&Be(i,()=>{i=null})):(i?Pe(i):l&&(i=_e(()=>l(n))),s&&Be(s,()=>{s=null})))};Xe(()=>{u=!1,e(f),u||c(null,null)},o)}function fn(t,e){return e}function cn(t,e,r,n){for(var s=[],i=e.length,a=0;a<i;a++)Qe(e[a].e,s,!0);var o=i>0&&s.length===0&&r!==null;if(o){var u=r.parentNode;Gr(u),u.append(r),n.clear(),V(t,e[0].prev,e[i-1].next)}er(s,()=>{for(var f=0;f<i;f++){var c=e[f];o||(n.delete(c.k),V(t,c.prev,c.next)),X(c.e,!o)}})}function dn(t,e,r,n,s,i=null){var a=t,o={flags:e,items:new Map,first:null};{var u=t;a=u.appendChild(Ht())}var f=null,c=!1,d=zt(()=>{var l=r();return kt(l)?l:l==null?[]:Ye(l)});Xe(()=>{var l=M(d),p=l.length;c&&p===0||(c=p===0,pn(l,o,a,s,e,n,r),i!==null&&(p===0?f?Pe(f):f=_e(()=>i(a)):f!==null&&Be(f,()=>{f=null})),M(d))})}function pn(t,e,r,n,s,i,a){var o=t.length,u=e.items,f=e.first,c=f,d,l=null,p=[],m=[],B,G,O,k;for(k=0;k<o;k+=1){if(B=t[k],G=i(B,k),O=u.get(G),O===void 0){var _=c?c.e.nodes_start:r;l=_n(_,e,l,l===null?e.first:l.next,B,G,k,n,s,a),u.set(G,l),p=[],m=[],c=l.next;continue}if(hn(O,B,k),O.e.f&W&&Pe(O.e),O!==c){if(d!==void 0&&d.has(O)){if(p.length<m.length){var g=m[0],y;l=g.prev;var A=p[0],P=p[p.length-1];for(y=0;y<p.length;y+=1)Bt(p[y],g,r);for(y=0;y<m.length;y+=1)d.delete(m[y]);V(e,A.prev,P.next),V(e,l,A),V(e,P,g),c=g,l=P,k-=1,p=[],m=[]}else d.delete(O),Bt(O,c,r),V(e,O.prev,O.next),V(e,O,l===null?e.first:l.next),V(e,l,O),l=O;continue}for(p=[],m=[];c!==null&&c.k!==G;)c.e.f&W||(d??(d=new Set)).add(c),m.push(c),c=c.next;if(c===null)continue;O=c}p.push(O),l=O,c=O.next}if(c!==null||d!==void 0){for(var F=d===void 0?[]:Ye(d);c!==null;)c.e.f&W||F.push(c),c=c.next;var te=F.length;if(te>0){var ue=o===0?r:null;cn(e,F,ue,u)}}w.first=e.first&&e.first.e,w.last=l&&l.e}function hn(t,e,r,n){Lt(t.v,e),t.i=r}function _n(t,e,r,n,s,i,a,o,u,f){var c=(u&$r)!==0,d=(u&Br)===0,l=c?d?Nt(s):$e(s):s,p=u&Ir?$e(a):a,m={i:p,v:l,k:i,a:null,e:null,prev:r,next:n};try{return m.e=_e(()=>o(t,l,p,f),Ur),m.e.prev=r&&r.e,m.e.next=n&&n.e,r===null?e.first=m:(r.next=m,r.e.next=m.e),n!==null&&(n.prev=m,n.e.prev=m.e),m}finally{}}function Bt(t,e,r){for(var n=t.next?t.next.e.nodes_start:r,s=e?e.e.nodes_start:r,i=t.e.nodes_start;i!==n;){var a=Ge(i);s.before(i),i=a}}function V(t,e,r){e===null?t.first=r:(e.next=r,e.e.next=r&&r.e),r!==null&&(r.prev=e,r.e.prev=e&&e.e)}function gn(t=!1){const e=b,r=e.l.u;if(!r)return;let n=()=>tn(e.s);if(t){let s=0,i={};const a=Je(()=>{let o=!1;const u=e.s;for(const f in u)u[f]!==i[f]&&(i[f]=u[f],o=!0);return o&&s++,s});n=()=>M(a)}r.b.length&&Lr(()=>{Pt(e,n),vt(r.b)}),qe(()=>{const s=or(()=>r.m.map(hr));return()=>{for(const i of s)typeof i=="function"&&i()}}),r.a.length&&qe(()=>{Pt(e,n),vt(r.a)})}function Pt(t,e){if(t.l.s)for(const r of t.l.s)M(r);e()}function vn(t){b===null&&Tr(),ve&&b.l!==null?mn(b).m.push(t):qe(()=>{const e=or(t);if(typeof e=="function")return e})}function mn(t){var e=t.l;return e.u??(e.u={a:[],b:[],m:[]})}const yn="5";typeof window<"u"&&(window.__svelte||(window.__svelte={v:new Set})).v.add(yn);Ar();const ne={f32:Float32Array,u32:Uint32Array,i32:Int32Array},ur=Uint32Array,xn=Uint32Array;function S(t){let e=1;for(const r of t)e*=r;return e}function wn(t=0,e=1){const r=1-Math.random(),n=Math.random();return Math.sqrt(-2*Math.log(r))*Math.cos(2*Math.PI*n)*e+t}function Le(t){let e=new Array(t.length);e[e.length-1]=1;for(let r=t.length-1;r>0;r--)e[r-1]=e[r]*t[r];return e}function I(t,e){return Math.ceil(t/e)}function Z(t){const e=new t.constructor(t.length);for(let r=0;r<t.length;r++)e[r]=t[r];return e}function St(t,e){const r=Z(t);for(let n=0;n<e.length;n++){const s=e[n];t[n]=r[s]}}function bn(t,e,r){const n=t[e];t[e]=r,t[r]=n}function pe(t,e){if(t.length!==e.length)return!1;for(let r=0;r<t.length;r++)if(t[r]!==e[r])return!1;return!0}function On(t,e,r,n=1/0){let s="";function i(a,o){for(let u=0;u<e[a];u++){if(u>n){s+="...";return}const f=o+u*r[a];if(a===e.length-1)s+=`${t[f]}`,u<e[a]-1&&(s+=", ");else{if(u>0)for(let c=0;c<a+1;c++)s+=" ";if(s+="[",i(a+1,f),s+="]",u<e[a]-1){s+=",";for(let c=0;c<e.length-a-1;c++)s+=`
`}}}}return s+="[",i(0,0),s+="]",s}function ce(t,e){return e<0?t+=e:e}function $(t,e,r="gid.x",n=-1,s=""){let i="",a=1;for(let o=t.length-1+n+1;o>=0;o--){const u=`(${s}(${r}/${a})%${t[o]})`;a*=t[o];const f=e[o];i+=`(${f}*${u})`,o>0&&(i+="+")}return i}function Dt(t,e,r){const n=new t.constructor(t.length+1);n[e]=r;let s=0;for(let i=0;i<n.length;i++)i!==e&&(n[i]=t[s],s++);return n}let E;class h{constructor(e,r,n,s,i=!0){v(E,"GPU must exist. Tensor.setDevice() once!"),this.gpuBuffer=e,this.shape=ur.from(r),this.strides=xn.from(n),this.dtype=s,this.owned=i}get DTypedArray(){return ne[this.dtype]}static setDevice(e){v(e!==void 0,"device not found!"),E=new tt(e)}static get gpu(){return v(E!==void 0,"gpu not found!"),E}setGPUBuffer(e,r=void 0){r=r===void 0?this.shape:r,e=this.DTypedArray.from(e),S(r)!==S(this.shape)&&(this.gpuBuffer.free(),this.gpuBuffer=E.memAlloc(e.byteLength)),E.memcpyHostToDevice(this.gpuBuffer,e)}static fill(e,r,n="f32"){const s=S(r),i=E.memAlloc(s*ne[n].BYTES_PER_ELEMENT),a=256;return E.SourceModule(`
			@group(0) @binding(0) var<storage, read_write> data: array<${n}>;
			@compute @workgroup_size(${a})
			fn main(@builtin(global_invocation_id) gid : vec3u) {
				if(gid.x < ${s}) {
					data[gid.x] = ${n}(${e});
				}
			}`).getFunction("main")([I(s,a)],i),new h(i,r,Le(r),n)}static tensor(e,r,n="f32"){const s=new ne[n](e),i=E.memAlloc(s.byteLength);return E.memcpyHostToDevice(i,s),new h(i,r,Le(r),n)}static empty(e,r="f32"){const n=E.memAlloc(S(e)*ne[r].BYTES_PER_ELEMENT);return new h(n,e,Le(e),r)}static random(e,r="f32"){const n=new ne[r](S(e)).fill(0).map(s=>Math.random());return h.tensor(n,e,r)}static randn(e,r=0,n=1,s="f32"){const i=new ne[s](S(e)).fill(0).map(a=>wn(r,n));return h.tensor(i,e,s)}static _elementWiseUnaryOpInplace(e,r){const n=S(e.shape),s=256,i=e.dtype;E.SourceModule(`
			@group(0) @binding(0) var<storage, read_write> dst: array<${i}>;
			@compute @workgroup_size(${s})
			fn main(@builtin(global_invocation_id) gid : vec3u) {
				if(gid.x < ${n}) {
					let dstIdx = ${$(e.shape,e.strides,"gid.x",-1)};
					${r}
				}
			}
			`).getFunction("main")([I(n,s)],e.gpuBuffer)}_elementWiseUnaryOpInplace(e){return h._elementWiseUnaryOpInplace(this,e),this}static _elementWiseUnaryOp(e,r,n){v(pe(e.shape,r.shape),"dst must have shape as src");const s=S(e.shape),i=256,a=e.dtype;E.SourceModule(`
			@group(0) @binding(0) var<storage, read_write> dst: array<${a}>;
			@group(0) @binding(1) var<storage, read> src: array<${a}>;
			@compute @workgroup_size(${i})
			fn main(@builtin(global_invocation_id) gid : vec3u) {
				if(gid.x < ${s}) {
					let srcIdx = ${$(r.shape,r.strides,"gid.x",-1)};
					let dstIdx = ${$(e.shape,e.strides,"gid.x",-1)};
					${n}
				}
			}
			`).getFunction("main")([I(s,i)],e.gpuBuffer,r.gpuBuffer)}_elementWiseUnaryOp(e){const r=h.empty(this.shape,this.dtype);return h._elementWiseUnaryOp(r,this,e),r}static sumLastDimension(e,r){v(e.dtype===r.dtype,"dst and src dtypes must match"),v(e.shape.at(-1)===1,"dimension we sum over should be 1 in dst");const n=S(e.shape),s=256,i=e.dtype;return E.SourceModule(`
			@group(0) @binding(0) var<storage, read_write> dst: array<${i}>;
			@group(0) @binding(1) var<storage, read> src: array<${i}>;

			@compute @workgroup_size(${s})
			fn main(@builtin(global_invocation_id) gid : vec3u) {
				if(gid.x < ${n}) {
					let baseSrcIdx = ${$(r.shape,r.strides,"gid.x",-2)};
					let baseDstIdx = ${$(e.shape,e.strides,"gid.x",-2)};
					var summed = ${i}(0);
					for(var i: u32 = 0; i < ${r.shape.at(-1)}; i++) {
						summed += src[baseSrcIdx + i*${r.strides.at(-1)}];
					}
					dst[baseDstIdx] = summed;
				}
			}`).getFunction("main")([I(n,s)],e.gpuBuffer,r.gpuBuffer),e}static reduceAnyDimensionGivenLastDimensionFunc(e,r,n,s=-1){const i=new Uint8Array(n.shape.length).fill(0).map((o,u)=>u);s=ce(n.shape.length,s);const a=n.shape.length-1;bn(i,s,a),e(r.transpose(i),n.transpose(i))}static sum(e,r,n=-1){h.reduceAnyDimensionGivenLastDimensionFunc(h.sumLastDimension,e,r,n)}static _elementWiseBinaryOp(e,r,n,s){v(pe(r.shape,n.shape),"srcA and srcB must have the same shape"),v(pe(e.shape,n.shape),"dst, srcA, and srcB, must have the same shape");const i=S(e.shape),a=256,o=e.dtype;E.SourceModule(`
			@group(0) @binding(0) var<storage, read_write> dst: array<${o}>;
			@group(0) @binding(1) var<storage, read> srcA: array<${o}>;
			@group(0) @binding(2) var<storage, read> srcB: array<${o}>;

		 	@compute @workgroup_size(${a})
		 	fn main(@builtin(global_invocation_id) gid : vec3u) {
				if(gid.x < ${i}) {
					let dstIdx = ${$(e.shape,e.strides,"gid.x",-1)};
					let srcAIdx = ${$(r.shape,r.strides,"gid.x",-1)};
					let srcBIdx = ${$(n.shape,n.strides,"gid.x",-1)};
					${s}
				}
			}`).getFunction("main")([I(i,a)],e.gpuBuffer,r.gpuBuffer,n.gpuBuffer)}_elementWiseBinaryOp(e,r){let n=!1;typeof e=="number"&&(e=h.tensor([e],this.shape,this.dtype),n=!0);const s=h.empty(e.shape,e.dtype);return h._elementWiseBinaryOp(s,this,e,r),n&&e.free(),s}static _elementWiseBinaryOpInplace(e,r,n){v(pe(e.shape,r.shape),"dst, src, must have the same shape");const s=S(e.shape),i=256,a=e.dtype;E.SourceModule(`
			@group(0) @binding(0) var<storage, read_write> dst: array<${a}>;
			@group(0) @binding(1) var<storage, read> src: array<${a}>;

		 	@compute @workgroup_size(${i})
		 	fn main(@builtin(global_invocation_id) gid : vec3u) {
				if(gid.x < ${s}) {
					let dstIdx = ${$(e.shape,e.strides,"gid.x",-1)};
					let srcIdx = ${$(r.shape,r.strides,"gid.x",-1)};
					${n}
				}
			}`).getFunction("main")([I(s,i)],e.gpuBuffer,r.gpuBuffer)}add(e){return this._elementWiseBinaryOp(e,"dst[dstIdx] = srcA[srcAIdx]+srcB[srcBIdx];")}sub(e){return this._elementWiseBinaryOp(e,"dst[dstIdx] = srcA[srcAIdx]-srcB[srcBIdx];")}mul(e){return this._elementWiseBinaryOp(e,"dst[dstIdx] = srcA[srcAIdx]*srcB[srcBIdx];")}div(e){return this._elementWiseBinaryOp(e,"dst[dstIdx] = srcA[srcAIdx]/srcB[srcBIdx];")}pow(e){return this._elementWiseBinaryOp(e,`dst[dstIdx] = ${this.dtype}(pow(f32(srcA[srcAIdx]), f32(srcB[srcBIdx])));`)}add_(e){return h._elementWiseBinaryOpInplace(this,e,"dst[dstIdx] += src[srcIdx];"),this}sub_(e){return h._elementWiseBinaryOpInplace(this,e,"dst[dstIdx] -= src[srcIdx];"),this}sum(e=-1){const r=Z(this.shape);r[ce(r.length,e)]=1;const n=h.empty(r,this.dtype);return h.sum(n,this,e),n}static maxLastDim(e,r){v(e.dtype===r.dtype,"dst and src dtypes must match"),v(e.shape.at(-1)===1,"dimension we sum over should be 1 in dst");const n=S(e.shape),s=256,i=e.dtype;return E.SourceModule(`
			@group(0) @binding(0) var<storage, read_write> dst: array<${i}>;
			@group(0) @binding(1) var<storage, read> src: array<${i}>;

			@compute @workgroup_size(${s})
			fn main(@builtin(global_invocation_id) gid : vec3u) {
				if(gid.x < ${n}) {
					let baseSrcIdx = ${$(r.shape,r.strides,"gid.x",-2)};
					let baseDstIdx = ${$(e.shape,e.strides,"gid.x",-2)};
					var max: ${i} = src[baseSrcIdx];
					for(var i: u32 = 0; i < ${r.shape.at(-1)}; i++) {
						let cur = src[baseSrcIdx + i*${r.strides.at(-1)}];
						if(cur > max) {
							max = cur;
						}
					}
					dst[baseDstIdx] = max;
				}
			}`).getFunction("main")([I(n,s)],e.gpuBuffer,r.gpuBuffer),e}static max(e,r,n=-1){h.reduceAnyDimensionGivenLastDimensionFunc(h.maxLastDim,e,r,n)}max(e=-1){const r=Z(this.shape);r[ce(r.length,e)]=1;const n=h.empty(r,this.dtype);return h.max(n,this,e),n}softmax(e=-1){const r=this.max(e),n=this.sub(r.expand(this.shape)),s=n.exp(),i=s.sum(e),a=s.div(i.expand(s.shape));return r.free(),n.free(),i.free(),s.free(),a}fillInplace(e){return this._elementWiseUnaryOpInplace(`dst[dstIdx] = ${this.dtype}(${e});`)}contiguous(){return this._elementWiseUnaryOp(dst,src,"dst[dstIdx] = src[srcIdx];")}exp(){return this._elementWiseUnaryOp("dst[dstIdx] = exp(src[srcIdx]);")}relu(){return this._elementWiseUnaryOp("dst[dstIdx] = max(src[srcIdx], 0);")}reciprocal(){return this._elementWiseUnaryOp(other,"dst[dstIdx] = 1/src[srcIdx];")}log(e=1e-6){return this._elementWiseUnaryOp(`dst[dstIdx] = log(src[srcIdx] + ${e});`)}get T(){return this.transpose()}transpose(e=void 0){if(this.shape===1)return this;e===void 0&&(e=[this.shape.length-1,0]);const r=Z(this.shape),n=Z(this.strides);return St(r,e),St(n,e),new h(this.gpuBuffer,r,n,this.dtype,!1)}unsqueeze(e=0){e=ce(this.shape.length+1,e);const r=Dt(this.shape,e,1),n=this.shape.slice(e).reduce((i,a)=>i*a,1),s=Dt(this.strides,e,n);return new h(this.gpuBuffer,r,s,this.dtype,!1)}expandTo(e,r){if(r=ce(this.shape.length,r),e===this.shape[r])return this;const n=Z(this.shape),s=Z(this.strides);return n[r]=e,s[r]=0,new h(this.gpuBuffer,n,s,this.dtype,!1)}expand(e){v(e.length===this.shape.length,"Must have same number of dims");let r=this;for(let n=0;n<e.length;n++){const s=e[n];r=r.expandTo(s,n)}return r}static matmul(e,r,n){v(r.shape.length===2&&n.shape.length===2&&e.shape.length===2,"tensors are matrix shaped"),v(r.shape.at(-1)===n.shape.at(0),"Inner dimension must be the same"),v(e.shape[0]===r.shape[0]&&e.shape[1]===n.shape[1],"output dimension lines up");const s=r.shape[1],i=e.dtype,a=16,o=16,u=E.SourceModule(`
			@group(0) @binding(0) var<storage, read_write> dst: array<${i}>;
			@group(0) @binding(1) var<storage, read> srcA: array<${i}>;
			@group(0) @binding(2) var<storage, read> srcB: array<${i}>;

		 	@compute @workgroup_size(${a}, ${o})
		 	fn main(@builtin(global_invocation_id) gid : vec3u) {
				let i = gid.x;
				let j = gid.y;
				if(gid.x < ${e.shape[0]} && gid.y < ${e.shape[1]}) {
					var summed: ${i} = 0;
					for(var k: u32 = 0; k < ${s}; k++) {
						let srcAIdx = i*${r.strides[0]} + k*${r.strides[1]};
						let srcBIdx = k*${n.strides[0]} + j*${n.strides[1]};
						summed += srcA[srcAIdx]*srcB[srcBIdx];	
					}

					let dstIdx = i*${e.strides[0]} + j*${e.strides[1]};
					dst[dstIdx] = summed;
				}
			}
		`).getFunction("main"),f=[I(e.shape[0],a),I(e.shape[1],o)];u(f,e.gpuBuffer,r.gpuBuffer,n.gpuBuffer)}matmul(e){const r=h.empty([this.shape[0],e.shape[1]],this.dtype);return h.matmul(r,this,e),r}static bmm(e,r,n){v(r.shape.at(-1)===n.shape.at(-2),"Inner dimension must be the same"),v(e.shape.at(-2)===r.shape.at(-2)&&e.shape.at(-1)===n.shape.at(-1),"output dimension lines up");const s=S(e.shape.slice(0,-2)),i=e.shape.at(-2),a=e.shape.at(-1),o=r.shape.at(-1),u=e.dtype,f=4,c=8,d=8,l=E.SourceModule(`
			@group(0) @binding(0) var<storage, read_write> dst: array<${u}>;
			@group(0) @binding(1) var<storage, read> srcA: array<${u}>;
			@group(0) @binding(2) var<storage, read> srcB: array<${u}>;

		 	@compute @workgroup_size(${f}, ${c}, ${d})
		 	fn main(@builtin(global_invocation_id) gid : vec3u) {
				let b = gid.x;
				let i = gid.y;
				let j = gid.z;
				if(b < ${s} && i < ${i} && j < ${a}) {
					let srcAOffset = ${$(r.shape,r.strides,"b",-3)};
					let srcBOffset = ${$(n.shape,n.strides,"b",-3)};
					let dstOffset = ${$(e.shape,e.strides,"b",-3)};

					var summed: ${u} = 0;
					for(var k: u32 = 0; k < ${o}; k++) {
						let srcAIdx = srcAOffset + i*${r.strides.at(-2)} + k*${r.strides.at(-1)};
						let srcBIdx = srcBOffset + k*${n.strides.at(-2)} + j*${n.strides.at(-1)};
						summed += srcA[srcAIdx]*srcB[srcBIdx];	
					}

					let dstIdx = dstOffset + i*${e.strides.at(-2)} + j*${e.strides.at(-1)};
					dst[dstIdx] = summed;
				}
			}
		`).getFunction("main"),p=[I(s,f),I(i,c),I(a,d)];l(p,e.gpuBuffer,r.gpuBuffer,n.gpuBuffer)}bmm(e){const r=[...this.shape.slice(0,-2),this.shape.at(-2),e.shape.at(-1)],n=h.empty(r);return h.bmm(n,this,e),n}static _softmaxJacobianLastDim(e,r){v(e.shape.at(-1)===e.shape.at(-2)&&e.shape.at(-1)===r.shape.at(-1));const n=S(e.shape.slice(-2)),s=e.shape.at(-1),i=e.dtype,a=4,o=8,u=8,f=E.SourceModule(`
			@group(0) @binding(0) var<storage, read_write> dst: array<${i}>;
			@group(0) @binding(1) var<storage, read> s: array<${i}>;

		 	@compute @workgroup_size(${a}, ${o}, ${u})
		 	fn main(@builtin(global_invocation_id) gid : vec3u) {
				let b = gid.x;
				let i = gid.y;
				let j = gid.z;

				if(b < ${n} && i < ${s} && j < ${s}) {
					let dstOffset = ${$(e.shape,e.strides,"b",-3)};
					let sOffset = ${$(r.shape,r.strides,"b",-2)};

					let siIdx = sOffset + i*${r.strides.at(-1)};
					let sjIdx = sOffset + j*${r.strides.at(-1)};
					let dijIdx = dstOffset + i*${e.strides.at(-2)} + j*${e.strides.at(-1)};

					let si = s[siIdx];
					let sj = s[sjIdx];
					if(i!=j) {
						dst[dijIdx] = -si*sj;
					}
					else {
						dst[dijIdx] = si*(1-si);
					}
				}
			}
		`).getFunction("main"),c=[I(n,a),I(s,o),I(s,u)];f(c,e.gpuBuffer,r.gpuBuffer)}_softmaxJacobian(){const e=this.shape.at(-1),r=h.empty([...this.shape.slice(0,-1),e,e]);return h._softmaxJacobianLastDim(r,this),r}async print(e=!0){this.assertNotFreed();const r=await this.cpuBuffer();let n="";n+=`dtype='${this.dtype}', `,n+=`shape=[${this.shape}], `,n+=`strides=[${this.strides}],
`,n+=`gpuBuffer=
${On(r,this.shape,this.strides,e?8:1/0)}
`,console.log(n)}async cpuBuffer(){return E.mapGPUToCPU(this.gpuBuffer,this.DTypedArray)}free(){this.gpuBuffer===void 0&&console.warn("Tried to free a gpuBuffer twice!"),this.gpuBuffer&&this.owned&&E.free(this.gpuBuffer),this.gpuBuffer=void 0}assertNotFreed(){v(this.gpuBuffer!==void 0,"This GPU Buffer has already been freed.")}}function v(t,e="ASSERT FAILED"){if(!t)throw new Error(e)}class tt{constructor(e){this.device=e}static async init(){const e=await navigator.gpu.requestAdapter();v(e,"adapter exists");const r=await e.requestDevice();return v(r,"device exists"),new tt(r)}async deviceSynchronize(){await this.device.queue.onSubmittedWorkDone()}memAlloc(e,r=GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST|GPUBufferUsage.COPY_SRC){return v(e>0),this.device.createBuffer({size:e,usage:r})}memcpyHostToDevice(e,r){this.device.queue.writeBuffer(e,0,r,0)}async memcpyDeviceToHost(e,r){e.set(await this.mapGPUToCPU(r,e.constructor))}free(e){e.destroy()}async printGPUBuffer(e,r=Float32Array){const n=await this.mapGPUToCPU(e,r);console.log(Array.from(n),n.constructor.name)}printDeviceInfo(){console.table(this.device.adapterInfo)}async mapGPUToCPU(e,r=Float32Array){const n=this.memAlloc(e.size,GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ),s=this.device.createCommandEncoder();return s.copyBufferToBuffer(e,0,n,0,e.size),this.device.queue.submit([s.finish()]),await n.mapAsync(GPUMapMode.READ),new r(n.getMappedRange())}SourceModule(e){return new En(this,e)}}class En{constructor(e,r){this.gpu=e,this.device=e.device,this.kernel=r}getFunctionExplicitBindings(e){const r=this.device.createShaderModule({code:this.kernel}),n=this.device.createComputePipeline({layout:"auto",compute:{module:r,entryPoint:e}}),s=n.getBindGroupLayout(0);return(i,...a)=>{v(i!==void 0);const o=this.device.createBindGroup({layout:s,entries:a}),u=this.device.createCommandEncoder(),f=u.beginComputePass();f.setPipeline(n),f.setBindGroup(0,o),f.dispatchWorkgroups(...i),f.end(),this.device.queue.submit([u.finish()])}}getFunctionOnlyBuffers(e){const r=this.getFunctionExplicitBindings(e);return(n,...s)=>{const i=s.map((a,o)=>({binding:o,resource:{buffer:a}}));r(n,...i)}}getFunction(e,r=!1){return r?this.getFunctionExplicitBindings(e):this.getFunctionOnlyBuffers(e)}}const An=14,[Tt,rt,nt,st,it,at,ot,ut,lt,ft,ct,dt,pt,ht]=new Array(An).fill(0).map((t,e)=>e),$n={[nt]:([t],e)=>t.sum(e),[it]:([t])=>t.pow(2),[ut]:([t],e)=>t.transpose(e),[lt]:([t],e)=>t.expand(e),[ft]:([t])=>t.relu(),[dt]:([t])=>t.exp(),[pt]:([t],e)=>t.softmax(e),[ht]:([t])=>t.log()},In={[nt]:([t],e,r)=>[()=>r.expand(t.shape)],[it]:([t],e,r)=>[()=>{const s=t.mul(2),i=r.mul(s);return s.free(),i}],[ut]:([t],e,r,n)=>[()=>r.transpose(n)],[lt]:([t],e,r,n)=>[()=>r.expand(t.shape)],[ft]:([t],e,r)=>[()=>e._elementWiseBinaryOp(r,`
				let result = srcA[srcAIdx];
				let resultGrad = srcB[srcBIdx];
				if(result > 0) {
					dst[dstIdx] = resultGrad;
				} else {
					dst[dstIdx] = 0;
				}
				`)],[dt]:([t],e,r)=>[()=>r.mul(e)],[pt]:([t],e,r)=>[()=>{const s=e._softmaxJacobian(),i=r.unsqueeze(1).bmm(s);return i.shape=e.shape,i.strides=e.strides,i}],[ht]:([t],e,r)=>[()=>{const s=t.pow(-1),i=r.mul(s);return s.free(),i}]},Bn={[rt]:([t,e])=>t.add(e),[st]:([t,e])=>t.sub(e),[at]:([t,e])=>t.mul(e),[ot]:([t,e])=>t.matmul(e),[ct]:([t,e])=>t.div(e)},Pn={[rt]:([t,e],r,n)=>[()=>n,()=>n],[st]:([t,e],r,n)=>[()=>n,()=>n.mul(-1)],[at]:([t,e],r,n)=>[()=>n.mul(e),()=>n.mul(t)],[ot]:([t,e],r,n)=>[()=>n.matmul(e.T),()=>t.T.matmul(n)],[ct]:([t,e],r,n)=>[()=>{const a=typeof e=="number"?h.tensor([1/e],t.shape):e.pow(-1),o=n.mul(a);return a.free(),o},()=>{const a=typeof e=="number"?h.tensor([1/(e*e)],t.shape):e.pow(-2),o=t.mul(-1),u=o.mul(a),f=n.mul(a);return a.free(),u.free(),o.free(),f}]};class J{constructor(e,r,n=[],s=void 0,i=!1){this.childArgs=r,this.opArgs=n,this.OP_CODE=e,this.tensor=s,this.grad=void 0,this.requiresGrad=i}static tensor(e,r=!1){return new J(Tt,[],[],e,r,e.shape)}get shape(){return v(this.tensor,"Tensor must exist to get shape. TODO: implement shape tracker to get around this."),this.tensor.shape}_unaryOp(e,...r){return new J(e,[this],r,void 0,this.requiresGrad)}softmax(e=-1){return this._unaryOp(pt,e)}exp(){return this._unaryOp(dt)}sum(e){return this._unaryOp(nt,e)}square(){return this._unaryOp(it)}get T(){return this.transpose()}transpose(e=void 0){return this._unaryOp(ut,e)}expand(e){return this._unaryOp(lt,e)}relu(){return this._unaryOp(ft)}log(){return this._unaryOp(ht)}_binaryOp(e,r,...n){return new J(r,[this,e],n,void 0,this.requiresGrad||e.requiresGrad)}div(e){return this._binaryOp(e,ct)}add(e){return this._binaryOp(e,rt)}sub(e){return this._binaryOp(e,st)}mul(e){return this._binaryOp(e,at)}matmul(e){return this._binaryOp(e,ot)}_getOpFunc(){let e;if(this.childArgs.length===1)e=$n;else if(this.childArgs.length===2)e=Bn;else throw new Error("Unknown op length");return v(this.OP_CODE in e,"Must have the function in the OP_MAP"),e[this.OP_CODE]}_getBackwardsOpFunc(){let e;if(this.childArgs.length===1)e=In;else if(this.childArgs.length===2)e=Pn;else throw new Error("Unknown op length");return v(this.OP_CODE in e,"Must have the function in the OP_MAP"),e[this.OP_CODE]}forward(){if(this.OP_CODE===Tt)return this.tensor;let e=new Array(this.childArgs.length);for(let n=0;n<this.childArgs.length;n++){const s=this.childArgs[n];typeof s=="number"?e[n]=s:e[n]=s.forward()}const r=this._getOpFunc();return this.tensor=r(e,...this.opArgs),this.tensor}_accumulateGradient(e){this.grad===void 0&&(this.grad=h.fill(0,this.tensor.shape,this.tensor.dtype)),this.grad.add_(e)}backward(){v(this.tensor,"result needs to be evaluated"),v(pe(new ur(this.tensor.shape.length).fill(1),this.tensor.shape),"Needs to be called on a reduce value (shape dimensions all 1)");const e=n=>{if(v(n.tensor,"result needs to be evaluated"),n.childArgs.length===0)return;const s=n._getBackwardsOpFunc(),i=n.childArgs.map(o=>typeof o=="number"?o:o.tensor),a=s(i,n.tensor,n.grad,...n.opArgs);for(let o=0;o<n.childArgs.length;o++){const u=n.childArgs[o],f=a[o];if(typeof u=="number"||u.requiresGrad===!1)continue;const c=f();u._accumulateGradient(c),e(u)}},r=h.fill(1,this.tensor.shape,this.tensor.dtype);this._accumulateGradient(r),e(this)}zeroGrad(){if(!(!this.grad||!this.requiresGrad)){this.grad.fillInplace(0);for(let e=0;e<this.childArgs.length;e++)typeof this.childArgs[e]!="number"&&this.childArgs[e].zeroGrad()}}freeGraph(){this.grad&&(this.grad.free(),this.grad=void 0),this.tensor&&(this.tensor.free(),this.tensor=void 0);for(let e=0;e<this.childArgs.length;e++)typeof this.childArgs[e]!="number"&&this.childArgs[e].freeGraph()}async print(...e){v(this.tensor,"result must be populated to print"),await this.tensor.print(...e)}}class Sn{constructor(e,r=.001){e.forEach(n=>v(n.requiresGrad,"Parameters must require gradients")),this.params=e,this.lr=r}update(){for(const e of this.params){v(e.grad&&e.tensor,"Can update data with gradient.");const r=e.grad.mul(this.lr);e.tensor.sub_(r),r.free()}}}var Dn=xe("<div>Loading MNIST Test 10k data...</div>"),Tn=xe("<div> </div>"),kn=xe("<div> </div>"),Un=xe("<!> <!> <div></div>",1);function Mn(t,e){Ft(e,!1);let r=Ne(!1);async function n(){we(r,!0);const g=await(await fetch("mnist_test.json")).json(),y=g.x,A=g.y;return we(r,!1),[y,A]}function s(_,g){const P=J.tensor(h.randn([_,g],0,.1),!0),F=J.tensor(h.randn([1,g],0,.1),!0);return[P,F]}function i(_,g=[728,128],y=32,A=10){let P=[];for(let Q=0;Q<g.length-1;Q++){const[fe,Y]=s(g[Q],g[Q+1]);P.push(fe),P.push(Y),_=_.matmul(fe).add(Y.expand([y,g[Q+1]])).relu()}const[F,te]=s(g.at(-1),A);return P.push(F),P.push(te),[_.matmul(F).add(te.expand([y,A])).softmax(-1),P]}function a(_,g,y=32){return _.log().mul(g).sum(-1).sum(0).mul(-1/y)}function o(_){const g=new Float32Array(_.length*_[0].length);for(let y=0;y<_.length;y++)for(let A=0;A<_[0].length;A++)g[y*_[0].length+A]=_[y][A];return g}const u=64,f=.1,c=5;let d=Ne([]),l=Ne();vn(async()=>{const g=await(await navigator.gpu.requestAdapter()).requestDevice();we(l,{vendor:g.adapterInfo.vendor,architecture:g.adapterInfo.architecture}),h.setDevice(g);const[y,A]=await n(),P=J.tensor(h.fill(1,[u,28*28])),[F,te]=i(P,[28*28,128,128],u),ue=J.tensor(h.fill(1,[u,10])),le=a(F,ue,u),Q=new Sn(te,f),fe=(Y,K)=>o(Y.slice(K,K+u));for(let Y=0;Y<c;Y++){console.log("EPOCH"+(Y+1));for(let K=0;K<y.length-u;K+=u)if(P.tensor.setGPUBuffer(fe(y,K)),ue.tensor.setGPUBuffer(fe(A,K)),le.forward(),le.zeroGrad(),le.backward(),Q.update(),K%10===0){const lr=await le.tensor.cpuBuffer();M(d).push(lr[0]),we(d,M(d))}}}),gn();var p=Un(),m=Rr(p);{var B=_=>{var g=Dn();de(_,g)};ze(m,_=>{M(r)&&_(B)})}var G=wt(m,2);{var O=_=>{var g=Tn(),y=We(g);bt(A=>It(y,`Running on ${A??""}`),[()=>JSON.stringify(M(l),null,4)],zt),de(_,g)};ze(G,_=>{M(l)&&_(O)})}var k=wt(G,2);dn(k,5,()=>M(d),fn,(_,g)=>{var y=kn(),A=We(y);bt(()=>It(A,`Loss: ${M(g)??""}`)),de(_,y)}),de(t,p),Ct()}var Rn=xe("<main><!></main>");function Gn(t){var e=Rn(),r=We(e);{var n=s=>{Mn(s,{})};ze(r,s=>{s(n)})}de(t,e)}on(Gn,{target:document.getElementById("app")});
